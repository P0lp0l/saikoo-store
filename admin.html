<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAIKO Admin | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ‘‘</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        :root {
            --bg-dark: #0f111a;
            --card-bg: #1a1d2b;
            --accent: #6c5ce7; /* Ø¨Ù†ÙØ³Ø¬ÙŠ Ù‡Ø§Ø¯ÙŠ */
            --text-main: #e0e0e0;
            --gold: #f1c40f;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
        .glass-card { 
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯ÙŠØ© */
        .stat-box { 
            background: rgba(108, 92, 231, 0.1); 
            border: 1px solid var(--accent);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .stat-box h2 { color: var(--gold); font-weight: 900; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ) */
        .form-control { 
            background: #25293d !important; 
            border: 1px solid #3d4461;
            color: #fff !important;
            border-radius: 10px;
            padding: 12px;
        }
        .form-control:focus { border-color: var(--accent); box-shadow: none; }

        /* Ø£Ø²Ø±Ø§Ø± Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
        .btn-saiko {
            background: var(--accent);
            color: white !important;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            padding: 12px 25px;
            transition: 0.3s;
        }
        .btn-saiko:hover { background: #5b4cc4; transform: translateY(-2px); }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table { color: var(--text-main); border-color: #3d4461; }
        .table thead { background: rgba(255,255,255,0.02); color: var(--gold); }
        
        .prod-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; border: 1px solid #3d4461; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comment-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .is-pinned-admin { border-right: 3px solid var(--gold); background: rgba(241, 196, 15, 0.05); }
        
        .pin-active { color: var(--gold) !important; }
    </style>
</head>
<body>

<div id="login-section" class="glass-card" style="max-width: 400px; margin: 100px auto;">
    <h3 class="text-center mb-4">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
    <input type="email" id="login-email" class="form-control mb-3" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="login-password" class="form-control mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn-saiko w-100" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="admin-content" class="container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-900">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</h2>
        <button class="btn btn-outline-secondary btn-sm rounded-pill" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-box">
                <small>Ø§Ù„Ù‚Ø·Ø¹</small>
                <h2 id="total-p" class="mb-0">0</h2>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-box">
                <small>Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</small>
                <h2 id="total-likes" class="mb-0">0</h2>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h5 class="mb-4"><i class="fas fa-plus-circle me-2"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h5>
        <div class="row g-3">
            <div class="col-md-6"><input type="text" id="p-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"></div>
            <div class="col-md-6"><input type="number" id="p-price" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±"></div>
            <div class="col-12">
                <div class="p-4 text-center" style="border: 2px dashed #3d4461; border-radius: 15px; cursor: pointer;" onclick="document.getElementById('p-files').click()">
                    <i class="fas fa-cloud-upload-alt fa-2x mb-2" style="color: var(--accent);"></i>
                    <p class="mb-0">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±</p>
                    <input type="file" id="p-files" hidden multiple onchange="handleFiles(this.files)">
                </div>
                <div id="preview-container" class="d-flex flex-wrap gap-2 mt-3 justify-content-center"></div>
            </div>
            <div class="col-12"><button class="btn-saiko w-100" onclick="addProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ âœ…</button></div>
        </div>
    </div>

    <div class="glass-card">
        <input type="text" id="admin-search" class="form-control mb-4" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="filterProducts()">
        <div class="table-responsive">
            <table class="table table-dark align-middle">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„ØªÙØ§Ø¹Ù„</th>
                        <th>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="product-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyDBfSCT_wePT2RexgcxZaz9NT9gWmXxgz0", 
        authDomain: "flafilo-store.firebaseapp.com", 
        projectId: "flafilo-store", 
        storageBucket: "flafilo-store.firebasestorage.app", 
        messagingSenderId: "470812703135", 
        appId: "1:470812703135:web:ee2359353b3ad64b36a5aa" 
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function saikoToast(msg, ok = true) {
        Toastify({ text: msg, duration: 2000, style: { background: ok ? "#6c5ce7" : "#e74c3c" } }).showToast();
    }

    auth.onAuthStateChanged(user => {
        document.getElementById('login-section').style.display = user ? 'none' : 'block';
        document.getElementById('admin-content').style.display = user ? 'block' : 'none';
        if (user) loadProducts();
    });

    async function login() {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-password').value;
        try { await auth.signInWithEmailAndPassword(e, p); } catch (err) { saikoToast("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©", false); }
    }

    function logout() { auth.signOut(); }

    let selectedFiles = [];
    function handleFiles(files) {
        selectedFiles = [...selectedFiles, ...Array.from(files)];
        const container = document.getElementById('preview-container'); container.innerHTML = '';
        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { container.innerHTML += `<img src="${e.target.result}" class="prod-img">`; };
            reader.readAsDataURL(file);
        });
    }

    async function addProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        if(!name || !price || selectedFiles.length === 0) return saikoToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", false);
        saikoToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...");
        let urls = [];
        try {
            for (let file of selectedFiles) {
                let fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=Ff535d677000fe55d5f463ccfdadc283`, { method: 'POST', body: fd });
                const data = await res.json(); urls.push(data.data.url);
            }
            await db.collection("gifts").add({ name, price, images: urls, likes: 0, dislikes: 0, createdAt: new Date() });
            location.reload();
        } catch (e) { saikoToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹", false); }
    }

    function loadProducts() {
        db.collection("gifts").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            let totalL = 0;
            document.getElementById('total-p').innerText = snap.size;
            snap.forEach(doc => {
                const p = doc.data();
                totalL += (p.likes || 0);
                list.innerHTML += `
                    <tr>
                        <td><img src="${p.images[0]}" class="prod-img me-2"> <span>${p.name}</span></td>
                        <td><input type="number" class="form-control p-1 text-center" style="width:80px" value="${p.price}" onchange="updatePrice('${doc.id}', this.value)"></td>
                        <td>ğŸ‘ ${p.likes||0}</td>
                        <td><div id="comm-${doc.id}" style="max-height:80px; overflow-y:auto; width:200px"></div></td>
                        <td><button class="btn btn-link text-danger p-0" onclick="deleteItem('${doc.id}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                loadComments(doc.id);
            });
            document.getElementById('total-likes').innerText = totalL;
        });
    }

    function loadComments(productId) {
        db.collection("gifts").doc(productId).collection("comments").orderBy("pinned", "desc").orderBy("createdAt", "desc").onSnapshot(snap => {
            const box = document.getElementById(`comm-${productId}`);
            if(!box) return;
            box.innerHTML = '';
            snap.forEach(d => {
                const c = d.data();
                box.innerHTML += `
                    <div class="comment-item ${c.pinned ? 'is-pinned-admin' : ''}">
                        <span class="text-truncate">${c.text}</span>
                        <div>
                            <i class="fas fa-thumbtack me-2 ${c.pinned ? 'pin-active' : ''}" style="cursor:pointer" onclick="togglePin('${productId}','${d.id}',${c.pinned})"></i>
                            <i class="fas fa-times text-muted" style="cursor:pointer" onclick="deleteComment('${productId}','${d.id}')"></i>
                        </div>
                    </div>`;
            });
        });
    }

    async function togglePin(pId, cId, current) {
        await db.collection("gifts").doc(pId).collection("comments").doc(cId).update({ pinned: !current });
    }

    async function updatePrice(id, newPrice) {
        await db.collection("gifts").doc(id).update({ price: newPrice });
        saikoToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø±");
    }

    async function deleteItem(id) { 
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) await db.collection("gifts").doc(id).delete();
    }

    async function deleteComment(pId, cId) {
        await db.collection("gifts").doc(pId).collection("comments").doc(cId).delete();
    }

    function filterProducts() {
        let input = document.getElementById('admin-search').value.toLowerCase();
        let rows = document.getElementById('product-list').getElementsByTagName('tr');
        for (let row of rows) { row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none"; }
    }
</script>
</body>
</html>
