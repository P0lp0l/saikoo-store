<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAIKO Admin | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ğŸ’</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        /* 1. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„ÙØ®Ù…Ø© */
        body { 
            font-family: 'Cairo', sans-serif; 
            background: linear-gradient(-45deg, #050505, #120d2b, #1a1a2e, #2d1b4e, #050505);
            background-size: 400% 400%;
            animation: moveBG 12s ease infinite;
            background-attachment: fixed;
            color: #ffffff; min-height: 100vh; padding: 20px;
        }
        @keyframes moveBG { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

        /* 2. ÙˆØ¶ÙˆØ­ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„ÙØ§Ø¦Ù‚ */
        h1, h2, h3, h4, .fw-900 { 
            font-weight: 900 !important; 
            text-shadow: 2px 4px 12px rgba(0,0,0,1); 
            color: #ffffff !important;
        }
        p, label, td, span { 
            font-weight: 700 !important; 
            text-shadow: 1px 2px 6px rgba(0,0,0,1); 
            color: #fdfdfd !important; 
        }

        /* 3. Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
        .glass-card { 
            background: rgba(0, 0, 0, 0.65); 
            backdrop-filter: blur(20px); 
            border-radius: 25px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 30px; margin-bottom: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .stat-box { 
            background: rgba(255, 255, 255, 0.07); 
            border: 1.5px solid #ff4d94;
            border-radius: 20px; padding: 25px; transition: 0.4s;
        }
        .stat-box h2 { color: #ff4d94 !important; font-size: 3rem; margin: 0; }

        /* 4. Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø£Ø¨ÙŠØ¶ ØµØ±ÙŠØ­) */
        .form-control { 
            background: #ffffff !important; 
            color: #000000 !important; 
            font-weight: 900 !important;
            border: 2px solid #ff4d94; 
            border-radius: 12px; padding: 12px;
        }

        .btn-saiko {
            background: linear-gradient(45deg, #ff4d94, #ff758c);
            color: #fff !important; font-weight: 900; font-size: 1.2rem;
            border: none; border-radius: 15px; padding: 14px;
            box-shadow: 0 8px 20px rgba(255, 77, 148, 0.4);
            transition: 0.3s; width: 100%;
        }
        .btn-saiko:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(255, 77, 148, 0.6); }

        .prod-img { width: 85px; height: 85px; border-radius: 15px; border: 2px solid #ff4d94; object-fit: cover; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± */
        .comment-item {
            background: rgba(255,255,255,0.08); border-radius: 10px;
            padding: 10px; margin-bottom: 8px; font-size: 0.85rem;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        .is-pinned-admin {
            border-right: 4px solid #00d4ff !important;
            background: rgba(0, 212, 255, 0.15) !important;
        }
        .pin-active { color: #00d4ff !important; transform: scale(1.2); }
    </style>
</head>
<body>

<div id="login-section" class="glass-card" style="max-width: 450px; margin: 80px auto;">
    <h2 class="text-center mb-4">ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§ÙŠÙƒÙˆ Ø³ØªÙˆØ±</h2>
    <div class="mb-3">
        <label class="mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="login-email" class="form-control">
    </div>
    <div class="mb-4">
        <label class="mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="login-password" class="form-control">
    </div>
    <button class="btn-saiko" onclick="login()">Ø¯Ø®ÙˆÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ğŸš€</button>
</div>

<div id="admin-content" class="container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-5 mt-2">
        <h1 class="fw-900">ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø± ğŸ’</h1>
        <button class="btn btn-outline-light rounded-pill px-4" onclick="logout()">Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>
    </div>

    <div class="row g-4 mb-5 text-center">
        <div class="col-md-6"><div class="stat-box"><h4>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹</h4><h2 id="total-p">0</h2></div></div>
        <div class="col-md-6"><div class="stat-box"><h4>â¤ï¸ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±</h4><h2 id="total-likes">0</h2></div></div>
    </div>

    <div class="glass-card mb-5">
        <h3 class="mb-4 text-info">âœ¨ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ÙÙ†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div class="row g-3">
            <div class="col-md-6"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="p-name" class="form-control"></div>
            <div class="col-md-6"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)</label><input type="number" id="p-price" class="form-control"></div>
            <div class="col-12 mt-4 text-center">
                <div style="border: 3px dashed #ff4d94; padding: 40px; border-radius: 20px; cursor: pointer; background: rgba(255,77,148,0.03);" onclick="document.getElementById('p-files').click()">
                    <i class="fas fa-images fa-3x mb-3" style="color:#ff4d94;"></i>
                    <h5 class="text-white fw-bold">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</h5>
                    <input type="file" id="p-files" hidden multiple onchange="handleFiles(this.files)">
                </div>
                <div id="preview-container" class="d-flex flex-wrap gap-2 mt-3 justify-content-center"></div>
            </div>
            <button class="btn-saiko mt-4" onclick="addProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù† ğŸ”¥</button>
        </div>
    </div>

    <div class="glass-card">
        <h3 class="mb-4 text-info">ğŸ“‹ Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
        <input type="text" id="admin-search" class="form-control mb-4" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="filterProducts()">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead class="text-info">
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th style="width: 120px;">Ø§Ù„Ø³Ø¹Ø± (ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±)</th>
                        <th>Ø§Ù„ØªÙØ§Ø¹Ù„</th>
                        <th style="min-width: 250px;">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Ø§Ù„Ù…Ø«Ø¨Øª Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰)</th>
                        <th>Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</th>
                    </tr>
                </thead>
                <tbody id="product-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const firebaseConfig = { 
        apiKey: "AIzaSyDBfSCT_wePT2RexgcxZaz9NT9gWmXxgz0", 
        authDomain: "flafilo-store.firebaseapp.com", 
        projectId: "flafilo-store", 
        storageBucket: "flafilo-store.firebasestorage.app", 
        messagingSenderId: "470812703135", 
        appId: "1:470812703135:web:ee2359353b3ad64b36a5aa" 
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function saikoToast(msg, isSuccess = true) {
        Toastify({ text: msg, duration: 3000, gravity: "top", position: "center", style: { background: isSuccess ? "#25d366" : "#ff4d4d", fontWeight: "900", borderRadius: "12px" } }).showToast();
    }

    // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¨Ù‚Ø§Ø¡ Ù…ØªØµÙ„Ø§Ù‹
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            loadProducts();
        } else {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
        }
    });

    async function login() {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-password').value;
        try {
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            await auth.signInWithEmailAndPassword(e, p);
            saikoToast("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ÙŠØ§ ÙŠÙˆØ³Ù! ğŸ‘‘");
        } catch (err) { saikoToast("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø·Ø£ âŒ", false); }
    }

    function logout() { auth.signOut(); }

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø±ÙØ¹
    let selectedFiles = [];
    function handleFiles(files) {
        selectedFiles = [...selectedFiles, ...Array.from(files)];
        const container = document.getElementById('preview-container'); container.innerHTML = '';
        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { container.innerHTML += `<img src="${e.target.result}" class="prod-img">`; };
            reader.readAsDataURL(file);
        });
    }

    async function addProduct() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        if(!name || !price || selectedFiles.length === 0) return saikoToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹! âš ï¸", false);
        
        saikoToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... Ø§Ù†ØªØ¸Ø± Ø«ÙˆØ§Ù†ÙŠ â³");
        let urls = [];
        try {
            for (let file of selectedFiles) {
                let fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=Ff535d677000fe55d5f463ccfdadc283`, { method: 'POST', body: fd });
                const data = await res.json();
                urls.push(data.data.url);
            }
            await db.collection("gifts").add({ name, price, images: urls, likes: 0, dislikes: 0, createdAt: new Date() });
            saikoToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
            location.reload();
        } catch (e) { saikoToast("ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹! âŒ", false); }
    }

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨ØªØ±ØªÙŠØ¨ "Ø§Ù„Ù…Ø«Ø¨Øª Ø£ÙˆÙ„Ø§Ù‹"
    function loadProducts() {
        db.collection("gifts").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            let totalL = 0;
            document.getElementById('total-p').innerText = snap.size;
            snap.forEach(doc => {
                const p = doc.data();
                totalL += (p.likes || 0);
                list.innerHTML += `
                    <tr>
                        <td><img src="${p.images[0]}" class="prod-img me-2"> <b>${p.name}</b></td>
                        <td><input type="number" class="form-control p-1 text-center" value="${p.price}" onchange="updatePrice('${doc.id}', this.value)"></td>
                        <td>ğŸ‘ ${p.likes||0} | ğŸ‘ ${p.dislikes||0}</td>
                        <td><div id="comm-${doc.id}" style="max-height:120px; overflow-y:auto;">ØªØ­Ù…ÙŠÙ„...</div></td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteItem('${doc.id}')"><i class="fas fa-trash-alt"></i></button></td>
                    </tr>`;
                loadComments(doc.id);
            });
            document.getElementById('total-likes').innerText = totalL;
        });
    }

    function loadComments(productId) {
        // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø­Ø±ÙŠ: pinned ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø«Ù… Ø§Ù„ÙˆÙ‚Øª ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹
        db.collection("gifts").doc(productId).collection("comments")
          .orderBy("pinned", "desc") 
          .orderBy("createdAt", "desc")
          .onSnapshot(snap => {
            const box = document.getElementById(`comm-${productId}`);
            if(!box) return;
            box.innerHTML = snap.empty ? '<small class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</small>' : '';
            snap.forEach(d => {
                const c = d.data();
                box.innerHTML += `
                    <div class="comment-item ${c.pinned ? 'is-pinned-admin' : ''}">
                        <span class="text-truncate" style="max-width:140px">${c.text}</span>
                        <div>
                            <i class="fas fa-thumbtack me-2 ${c.pinned ? 'pin-active' : ''}" 
                               style="cursor:pointer; color:${c.pinned ? '#00d4ff' : '#666'}" 
                               onclick="togglePin('${productId}','${d.id}',${c.pinned})"></i>
                            <i class="fas fa-times-circle text-danger" style="cursor:pointer" onclick="deleteComment('${productId}','${d.id}')"></i>
                        </div>
                    </div>`;
            });
        });
    }

    // 4. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… (ØªØ¹Ø¯ÙŠÙ„ØŒ ØªØ«Ø¨ÙŠØªØŒ Ø­Ø°Ù)
    async function updatePrice(id, newPrice) {
        await db.collection("gifts").doc(id).update({ price: newPrice });
        saikoToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­! ğŸ’¸");
    }

    async function togglePin(pId, cId, current) {
        try {
            await db.collection("gifts").doc(pId).collection("comments").doc(cId).update({ pinned: !current });
            saikoToast(!current ? "ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ ğŸ“Œ" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª");
        } catch (e) {
            console.error("Error pinning:", e);
            saikoToast("ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Index ÙÙŠ Firebase Console", false);
        }
    }

    async function deleteComment(pId, cId) {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ")) {
            await db.collection("gifts").doc(pId).collection("comments").doc(cId).delete();
            saikoToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ğŸ—‘ï¸", false);
        }
    }

    async function deleteItem(id) { 
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await db.collection("gifts").doc(id).delete();
            saikoToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ğŸ—‘ï¸");
        }
    }

    function filterProducts() {
        let input = document.getElementById('admin-search').value.toLowerCase();
        let rows = document.getElementById('product-list').getElementsByTagName('tr');
        for (let row of rows) { row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none"; }
    }
</script>
</body>
</html>
